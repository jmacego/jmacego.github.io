---
import { site } from "../siteData";

const { title, description, ogImage, ogType } = Astro.props;
const pathname = Astro.url.pathname;
const pageTitle = title ? `${title} | ${site.title}` : site.title;
const pageDescription = description ?? site.description;
const ogImageUrl = ogImage ? new URL(ogImage, site.url).toString() : undefined;
const ogContentType = ogType ?? "website";

const navLinks = site.nav;
const isActive = (href) => {
  if (href === "/") {
    return pathname === "/";
  }
  return pathname.startsWith(href);
};
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    <meta name="color-scheme" content="light dark" />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:type" content={ogContentType} />
    <meta property="og:url" content={site.url + pathname} />
    {ogImageUrl && <meta property="og:image" content={ogImageUrl} />}
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+3:wght@400;500;600&family=Space+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png" />
    <link rel="manifest" href="/assets/images/site.webmanifest" />
    <link rel="stylesheet" href="/assets/styles.css" />
    <meta name="theme-color" content="#f8f3ec" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#111115" media="(prefers-color-scheme: dark)" />
  </head>
  <body>
    <span id="top-of-page"></span>
    <header class="site-header">
      <div class="container">
        <div class="header-row">
          <div class="brand">
            <a class="brand-title" href="/">{site.title}</a>
            <p class="brand-tag">Networking, infrastructure, and automation</p>
          </div>
        </div>
        <nav class="nav-scroller" aria-label="Primary">
          {navLinks.map((link) => (
            <a
              class:list={["nav-link", isActive(link.href) && "active"]}
              href={link.href}
              aria-current={isActive(link.href) ? "page" : undefined}
            >
              {link.label}
            </a>
          ))}
        </nav>
      </div>
    </header>

    <main class="container">
      <slot />
    </main>

    <footer class="site-footer">
      <div class="container">
        <p>jmaclabs.com &mdash; building resilient systems and thoughtful teams.</p>
      </div>
    </footer>

    {site.gaId && (
      <div id="cookie-notice" class="cookie-notice" aria-live="polite">
        <span>We use Google Analytics to understand how the site is used.</span>
        <div class="cookie-actions">
          <button id="cookie-notice-accept" class="button" type="button">
            Approve
          </button>
          <button id="cookie-notice-deny" class="button ghost" type="button">
            Deny
          </button>
        </div>
      </div>
    )}

    {site.gaId && (
      <script is:inline>
        const cookieName = "cookie-notice-option";

        function createCookie(name, value, days) {
          let expires = "";
          if (days) {
            const date = new Date();
            date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
            expires = "; expires=" + date.toUTCString();
          }
          document.cookie = name + "=" + value + expires + "; path=/";
        }

        function readCookie(name) {
          const nameEQ = name + "=";
          const ca = document.cookie.split(";");
          for (let i = 0; i < ca.length; i += 1) {
            let c = ca[i];
            while (c.charAt(0) === " ") c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
          }
          return null;
        }

        function loadAnalytics() {
          const script = document.createElement("script");
          script.async = true;
          script.src = "https://www.googletagmanager.com/gtag/js?id=" + "${site.gaId}";
          document.head.appendChild(script);

          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag("js", new Date());
          gtag("config", "${site.gaId}", { anonymize_ip: true });
        }

        const notice = document.getElementById("cookie-notice");
        const option = readCookie(cookieName);

        if (option === "true") {
          loadAnalytics();
        } else if (option !== "false" && notice) {
          notice.style.display = "flex";
        }

        const accept = document.getElementById("cookie-notice-accept");
        const deny = document.getElementById("cookie-notice-deny");

        if (accept) {
          accept.addEventListener("click", () => {
            createCookie(cookieName, "true", 31);
            if (notice) notice.style.display = "none";
            loadAnalytics();
          });
        }

        if (deny) {
          deny.addEventListener("click", () => {
            createCookie(cookieName, "false", 31);
            if (notice) notice.style.display = "none";
          });
        }
      </script>
    )}
  </body>
</html>
