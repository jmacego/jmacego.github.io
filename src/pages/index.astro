---
import BaseLayout from "../layouts/BaseLayout.astro";
import {
  formatDate,
  getEntryDate,
  getExcerpt,
  getExcerptText,
  isPublished,
  normalizeImagePath,
  sortByDateDesc,
  stripDatePrefix,
} from "../utils/content";
import { getCollection } from "astro:content";

const posts = (await getCollection("posts", isPublished)).sort(sortByDateDesc);
const projects = (await getCollection("projects", isPublished)).sort(sortByDateDesc);

const heroPost = posts[0];
const secondaryPost = posts[1];
const featuredProject = projects[0];

const heroImage = normalizeImagePath(heroPost?.data.image?.path);
const secondaryImage = normalizeImagePath(secondaryPost?.data.image?.path);
const projectImage = normalizeImagePath(featuredProject?.data.image?.path);

const heroExcerpt = heroPost ? getExcerpt(heroPost.body) : "";
const secondaryExcerpt = secondaryPost ? getExcerpt(secondaryPost.body) : "";
const projectExcerpt = featuredProject ? getExcerpt(featuredProject.body) : "";

const pageDescription = heroPost
  ? getExcerptText(heroPost.body)
  : "John MacDonald — Networking, Infrastructure, and Automation";

const heroDate = heroPost ? getEntryDate(heroPost) : undefined;
const secondaryDate = secondaryPost ? getEntryDate(secondaryPost) : undefined;
const projectDate = featuredProject ? getEntryDate(featuredProject) : undefined;
---

<BaseLayout title="John MacDonald — Networking, Infrastructure, and Automation" description={pageDescription}>
  <div class="jumbotron p-4 p-md-5 text-white rounded bg-dark">
    <div class="row">
      {heroPost && (
        <div class:list={["px-0", heroImage ? "col-md-6" : "col"]}>
          <h1 class="display-4 font-italic">
            <a class="text-white" href={`/blog/${stripDatePrefix(heroPost.slug)}/`}>
              {heroPost.data.title}
            </a>
          </h1>
          {heroDate && <div class="mb-1 text-muted">{formatDate(heroDate)}</div>}
          <p class="lead my-3" set:html={heroExcerpt} />
          <p class="lead mb-0">
            <a
              href={`/blog/${stripDatePrefix(heroPost.slug)}/`}
              title={heroPost.data.title}
              class="text-white font-weight-bold"
            >
              Continue reading...
            </a>
          </p>
        </div>
      )}
      {heroPost && heroImage && (
        <div class="col-md-6 px-0" style="height: 100%; width: 100%">
          <a href={`/blog/${stripDatePrefix(heroPost.slug)}/`}>
            <img
              style="object-fit: cover; width: inherit; height: inherit; max-width: 100%; max-height: 100%"
              src={heroImage}
              alt={heroPost.data.image?.alt ?? heroPost.data.title}
            />
          </a>
        </div>
      )}
    </div>
  </div>

  <div class="row mb-2">
    <div class="col-md-6 px-0">
      <div class="row no-gutters border rounded overflow-hidden flex-md-row mb-4 shadow-sm h-md-250 position-relative">
        <div class="col p-4 d-flex flex-column position-static">
          <strong>
            <a class="d-inline-block mb-2 text-primary" href="/blog/">Posts</a>
          </strong>
          {secondaryPost && (
            <>
              <h3 style="font-size:1.5rem" class="mb-0">{secondaryPost.data.title}</h3>
              {secondaryDate && <div class="mb-1 text-muted">{formatDate(secondaryDate)}</div>}
              <p class="mb-auto" set:html={secondaryExcerpt} />
              <a
                class="stretched-link"
                href={`/blog/${stripDatePrefix(secondaryPost.slug)}/`}
                title={secondaryPost.data.title}
              >
                Continue reading {secondaryPost.data.title}
              </a>
            </>
          )}
        </div>
        {secondaryPost && secondaryImage && (
          <div class="col d-none d-lg-block" style="height: 100%; width: 100%">
            <img
              style="object-fit: cover; width: inherit; height: inherit; max-width: 100%; max-height: 100%"
              src={secondaryImage}
              alt={secondaryPost.data.image?.alt ?? secondaryPost.data.title}
            />
          </div>
        )}
      </div>
    </div>
    <div class="col-md-6 px-0">
      <div class="row no-gutters border rounded overflow-hidden flex-md-row mb-4 shadow-sm h-md-250 position-relative">
        <div class="col p-4 d-flex flex-column position-static">
          <strong>
            <a class="d-inline-block mb-2 text-success" href="/projects/">Projects</a>
          </strong>
          {featuredProject && (
            <>
              <h3 style="font-size:1.5rem" class="mb-0">{featuredProject.data.title}</h3>
              {projectDate && <div class="mb-1 text-muted">{formatDate(projectDate)}</div>}
              <p class="mb-auto" set:html={projectExcerpt} />
              <a
                class="stretched-link"
                href={`/projects/${stripDatePrefix(featuredProject.slug)}/`}
                title={featuredProject.data.title}
              >
                Continue reading {featuredProject.data.title}
              </a>
            </>
          )}
        </div>
        {featuredProject && projectImage && (
          <div class="col d-none d-lg-block" style="height: 100%; width: 100%">
            <img
              style="object-fit: cover; width: inherit; height: inherit; max-width: 100%; max-height: 100%"
              src={projectImage}
              alt={featuredProject.data.image?.alt ?? featuredProject.data.title}
            />
          </div>
        )}
      </div>
    </div>
  </div>
</BaseLayout>
